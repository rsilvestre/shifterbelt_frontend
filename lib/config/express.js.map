{"version":3,"sources":["../../src/config/express.es6"],"names":[],"mappings":"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","file":"express.js","sourcesContent":["import express  from 'express';\nimport favicon from 'serve-favicon';\nimport morgan from 'morgan';\nimport cookieParser from 'cookie-parser';\nimport bodyParser from'body-parser';\n\nimport fs from \"fs\"\nimport path from 'path';\n\nimport mongoose from \"mongoose\"\n\nimport genUuid from \"../helper/genUuid.js\"\n\nimport url from \"url\";\n\nimport swig from \"swig\";\nimport moment from 'moment';\nimport extras from \"swig-extras\";\nimport nsh from \"node-syntaxhighlighter\"\n\nimport ua from 'universal-analytics';\n\nimport methodOverride from \"method-override\";\n\nimport multer from \"multer\";\n\nimport redis from \"redis\";\nimport session from \"express-session\";\nimport sessionStore from \"sessionstore\";\n\nimport compression from \"compression\";\n\nimport csrf from \"csurf\";\nimport mongoStore from \"connect-mongo\";\nimport flash from \"connect-flash\";\nimport winston from \"winston\";\nimport helpers from \"view-helpers\";\n\nimport config from \"config\";\n\nimport pkg from \"../package.json\";\n\nlet env = process.env.MODE_ENV || \"development\";\n\n/**\n * expost\n * @param app\n * @param passport\n */\nmodule.exports = function(app, passport) {\n\n  app.use(compression({\n    threshold: 512\n  }));\n\n  // Use winston on production\n  let log;\n  if (env !== 'development') {\n    log = {\n      stream: {\n        write: function(message, encoding) {\n          winston.info(message);\n        }\n      }\n    };\n  } else {\n    log = 'dev';\n  }\n\n  var redisURL = url.parse(process.env.REDISCLOUD_URL || 'redis://localhost:6379');\n  var client = redis.createClient(redisURL.port, redisURL.hostname, { no_ready_check: true });\n  if (redisURL.auth) {\n    client.auth(redisURL.auth.split(\":\")[1]);\n  }\n\n  // view engine setup\n  app.set('views', `${config.root}/app/views`);\n  app.engine('swig', swig.renderFile);\n  app.set('view engine', 'swig');\n\n  swig.setFilter('length', (input) => {\n    if (Object.prototype.toString.call(input) === '[object Array]') {\n      return input.length;\n    }\n  });\n\n  swig.setFilter('moment', (input) => {\n    return moment(input).fromNow();\n  });\n\n  swig.setFilter('lastPrice', (input) => {\n    return input.slice(-1)[0]['value'];\n  });\n\n  swig.setFilter('numberize', (input) => {\n    return ('' + input).split('').reverse().map(function(value, index) {\n      if ((index + 1) % 3 === 0) {\n        return ',' + value;\n      }\n      return value;\n    }).reverse().join('').replace(/^,/,'');\n  });\n\n  let sample = (input) => {\n    let language = nsh.getLanguage('js');\n\n    return nsh.highlight(input.replace(/end/g, '\\n').replace(/tabulation\\:/g, '\\t'), language, {\n      brush: \"js\",\n      gutter: false\n    });\n  };\n  sample.safe = true;\n  swig.setFilter('sample', sample);\n\n  extras.useFilter(swig, 'markdown');\n\n  app.use(ua.middleware('UA-', { coockieName: '_ga' }));\n\n  // uncomment after placing your favicon in /public\n  //app.use(favicon(__dirname + '/public/favicon.ico'));\n  if (env !== 'test') {\n    app.use(morgan(log));\n  }\n  app.use(bodyParser.json());\n  app.use(bodyParser.urlencoded({ extended: false }));\n  app.use(cookieParser());\n  app.use(express.static(`${config.root}/public`));\n  app.use(methodOverride(\"_method\"));\n\n  app.use(session({\n    genid: function(req) {\n      return genUuid(); // use UUIDs for session IDs\n    },\n    secret: process.env.SESSION_SECRET || 'hello world',\n    name: \"tiny_cookie\",\n    store: sessionStore.createSessionStore(process.env.REDISCLOUD_URL ? { url: process.env.REDISCLOUD_URL } : {\n      type: 'redis',\n      host: 'localhost',         // optional\n      port: 6379,                // optional\n      prefix: 'sess',            // optional\n      ttl: 804600,               // optional\n      timeout: 10000             // optional\n    }),\n    resave: true,\n    saveUninitialized: true\n  }));\n\n  app.use(multer({\n    dest: './uploads/',\n    rename: function(fieldname, filename) {\n      return filename.replace(/\\W+/g, '-').toLowerCase() + Date.now()\n    },\n    limits: {\n      fieldNameSize: 50,\n      fieldSize: 4000000,\n      files: 2,\n      fields: 10\n    }\n  }));\n\n  // use passport session\n  app.use(passport.initialize());\n  app.use(passport.session());\n\n  // connect flash for flash messages - shoud be declared after sessions\n  app.use(flash());\n\n  // should be declared after session ans flash\n  app.use(helpers(pkg.name));\n\n  // adds CSRF support\n  if (env !== 'test') {\n    app.use(csrf());\n\n    app.use((req, res, next) => {\n      res.locals.csrf_token = req.csrfToken();\n      next();\n    });\n  }\n\n  app.use((req, res, next) => {\n    res.locals.pkg = pkg;\n    res.locals.env = env;\n    next();\n  });\n\n  app.use(function(req, res, next) {\n    req.visitor.pageview(req.originalUrl).send();\n    next();\n  });\n\n  /*\n   // catch 404 and forward to error handler\n   app.use(function (req, res, next) {\n   var err = new Error('Not Found');\n   err.status = 404;\n   next(err);\n   });\n   */\n  // error handlers\n\n  // development error handler\n  // will print stacktrace\n  if (env === 'development' || env === 'test') {\n    app.set('view cache', false);\n    swig.setDefaults({ cache: false });\n    /*\n     app.use(function (err, req, res, next) {\n\n     console.error(err.message);\n     console.error(err.stack);\n     res.status(err.status || 500);\n     res.render('error_template', {\n     title: 'Internal error',\n     message: err.message,\n     error: err\n     });\n     });\n     */\n  }\n\n  /*\n   // production error handler\n   // no stacktraces leaked to user\n   app.use(function (err, req, res, next) {\n   res.status(err.status || 500);\n   res.render('error', {\n   message: err.message,\n   error: {}\n   });\n   });\n   */\n};\n\n"]}