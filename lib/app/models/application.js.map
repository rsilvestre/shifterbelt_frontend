{"version":3,"sources":["../../../src/app/models/application.js"],"names":[],"mappings":"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","file":"application.js","sourcesContent":["/**\n * Module dependencies.\n */\n\nvar shortid = require('shortid');\nvar config = require('config');\nvar utils = require(config.root + '/lib/utils.js');\nvar mongoose = require('mongoose');\nvar crypto = require('crypto');\nvar token = require('token');\n\ntoken.defaults.secret = 'uj1k9iEq7LYNCFlLU0AZS2MEfYKGVVif8OpPBNc1';\ntoken.defaults.timeStep = 24 * 60 * 60; // 24h in seconds\n\nvar Schema = mongoose.Schema;\n\nvar makeSalt = function() {\n  \"use strict\";\n\n  return Math.round((new Date().valueOf() * Math.random())) + '';\n};\n\nvar encryptPassword = function(password) {\n  \"use strict\";\n\n  if (!password) {\n    return '';\n  }\n  try {\n    return crypto\n      .createHmac('sha1', this.salt)\n      .update(password)\n      .digest('hex');\n  } catch (err) {\n    return '';\n  }\n};\n\nvar Generator = function(preSave) {\n\n  if (false === (this instanceof Generator)) {\n    return new Generator(preSave);\n  }\n\n  var Application = mongoose.model('Application');\n\n  this.businessId = function(cb) {\n    var businessId = makeSalt();\n    Application.find({ 'businessId': businessId })\n      .select('businessId')\n      .exec(function(err, result) {\n        if (err) {\n          return cb(err);\n        }\n\n        if (result.length > 0) {\n          return generate(cb);\n        }\n        preSave.businessId = businessId;\n        cb();\n      });\n  };\n\n  this.keys = function(cb) {\n    \"use strict\";\n\n    var keyGen = function(type) {\n      return {\n        role: type,\n        key: crypto.createHmac('sha1', Math.random().toString()).update((new Date()).valueOf().toString()).digest('hex').substring(0, 40),\n        passwd: token.generate((new Date()).valueOf().toString() + '|' + Math.random().toString()).substring(0, 80)\n      };\n    };\n    preSave.keys.push(new keyGen(\"master\"));\n    preSave.keys.push(new keyGen(\"manager\"));\n    preSave.keys.push(new keyGen(\"slave\"));\n    cb();\n  };\n\n};\n/**\n * Getter\n */\n\nvar getBusinessId = function(businessId) {\n  \"use strict\";\n  return businessId;\n};\n\n/**\n * Setter\n */\n\nvar setBusinessId = function(businessId) {\n  \"use strict\";\n  if (this.isNew) {\n    return businessId;\n  }\n  return this.businessId;\n};\n\n/**\n * Application Schema\n */\n\nvar ApplicationSchema = new Schema({\n  name: { type: String, required: true, trim: true, index: true, unique: \"Name cannot be blank\" },\n  businessId: { type: String, index: true, unique: true },\n  strategy: { type: String, required: 'The strategy has not been defined', enum: ['direct', 'work'] },\n  users: [{\n    _id: { type: Schema.ObjectId, ref: 'User', required: true },\n    role: { type: String, required: true, enum: [\"owner\", \"manager\", \"invited\"] },\n    createdAt: { type: Date, default: Date.now }\n  }],\n  createdAt: { type: Date, default: Date.now },\n  keys: [{\n    role: { type: String, required: true, enum: [\"master\", \"manager\", \"slave\"] },\n    key: { type: String, required: true },\n    passwd: { type: String, required: true },\n    createdAt: { type: Date, default: Date.now },\n    status: { type: String, default: 'active', enum: ['active', 'inactive', 'revoked'] }\n  }]\n});\n\n/**\n * Virtuals\n */\n\n\n/**\n * Validations\n */\n\n/**\n * Pre-save hook\n */\n\nApplicationSchema.pre('save', function(next) {\n  \"use strict\";\n\n  if (!this.isNew) {\n    return next();\n  }\n\n\n  var generator = new Generator(this);\n\n  generator.businessId(function() {\n    generator.keys(next);\n  });\n\n\n});\n\n/**\n * Methods\n */\n\nApplicationSchema.methods = {\n  addUser: function(user, role, cb) {\n    \"use strict\";\n    var notify = require('../mailer');\n    this.users.push({\n      _id: user._id,\n      role: role\n    });\n\n    notify.createApplication({\n      application: this,\n      currentUser: user\n    });\n\n    this.save(cb);\n  }, /**\n   * Authenticate - check if the passwords are the same\n   *\n   * @param {String} plainText\n   * @return {Boolean}\n   * @api public\n   */\n\n  authenticate: function(plainText) {\n    return this.encryptPassword(plainText) === this.hashed_password;\n  },\n\n  /**\n   * Make salt\n   *\n   * @return {String}\n   * @api public\n   */\n\n  makeSalt: makeSalt,\n\n  /**\n   * Encrypt password\n   *\n   * @param {String} password\n   * @return {String}\n   * @api public\n   */\n\n  encryptPassword: encryptPassword\n};\n\n/**\n * Statics\n */\nApplicationSchema.statics = {\n  /**\n   *\n   * @param id\n   * @param cb\n   * @api public\n   */\n  load: function(id, user, cb) {\n    \"use strict\";\n    this.findOne({ businessId: id })\n      .populate('users._id', 'name email username')\n      .exec(cb);\n  },\n\n  list: function(options, cb) {\n    \"use strict\";\n\n    var criteria = options.criteria || {};\n\n    this.find(criteria)\n      .populate('users._id', 'name email username')\n      .exec(cb);\n  },\n\n\n  /**\n   *\n   * @param businessId\n   * @param cb\n   * @api public\n   */\n  selectByBusinessId: function(businessId, cb) {\n    \"use strict\";\n    this.findOne({ businessId: businessId,  })\n      .populate('users._id', 'name email username')\n      .select('name')\n      .exec(cb);\n  }\n};\n\nmongoose.model('Application', ApplicationSchema);\n\n"]}