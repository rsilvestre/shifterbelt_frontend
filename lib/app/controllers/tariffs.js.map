{"version":3,"sources":["../../../src/app/controllers/tariffs.js"],"names":[],"mappings":"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","file":"tariffs.js","sourcesContent":["/**\n * Module dependencies.\n */\n\nvar mongoose = require('mongoose');\nvar Tariff = mongoose.model('Tariff');\nvar Plan = mongoose.model('Plan');\nvar utils = require('../../lib/utils');\nvar countries = require('../../utils/countries.json');\n/**\n * Load by Id\n * @param {{}} req\n * @param {{}} res\n * @param {Function} next\n * @param {String} id\n */\nexports.loadId = function(req, res, next, id) {\n  Tariff.loadId(id, function(err, tariff) {\n    if (err) {\n      return next(err);\n    }\n    if (!tariff) {\n      return next(new Error('Failed to load Tariff ' + id));\n    }\n    req.tariff = tariff;\n    next();\n  });\n};\n\n/**\n * Load by Name\n * @param {{}} req\n * @param {{}} res\n * @param {Function} next\n * @param {String} name\n */\nexports.loadName = function(req, res, next, name) {\n  Tariff.loadName(name, function(err, tariff) {\n    if (err) {\n      return next(err);\n    }\n    if (!tariff) {\n      return next(new Error('Failed to load Tariff ' + id));\n    }\n    req.tariff = tariff;\n    next();\n  });\n};\n\n/**\n *\n * @param {{}} req\n * @param {{}} res\n */\nexports.index = function(req, res) {\n  \"use strict\";\n\n  Tariff.allNotFree(function(err, tariffsNotFree) {\n    if (err) {\n      req.flash('info', \"Sorry! We are not able to find the tariffs!\");\n    }\n    Tariff.allFree(function(err, tariffsFree) {\n      if (err) {\n        req.flash('info', \"Sorry! We are not able to find the tariffs!\");\n      }\n      res.render('tariffs/index', {\n        title: \"Tariffs\",\n        tariffsNotFree: tariffsNotFree,\n        tariffsFree: tariffsFree\n      });\n    });\n  });\n};\n\n/**\n *\n * @param {{}} req\n * @param {{}} res\n */\nexports.payment = function(req, res) {\n  \"use strict\";\n\n  var tariff = req.tariff;\n  res.render('tariffs/payment', {\n    action: \"/tariffs/\" + tariff.name + \"/create\",\n    title: \"Tariff details\",\n    countries: countries,\n    tariff: tariff\n  });\n\n};\n\n/**\n * Create payment\n * @param {{}} req\n * @param {{}} res\n */\nexports.create = function(req, res) {\n\n  var tariff = req.tariff;\n  var plan = new Plan(req.body);\n  plan.tariffPlan = tariff._id;\n\n  plan.save(function(err) {\n    \"use strict\";\n    if (err) {\n      return res.render('tariffs/payment', {\n        action: \"/tariffs/\" + tariff.name + \"/create\",\n        title: \"Tariff details\",\n        countries: countries,\n        tariff: tariff,\n        errors: utils.errors(err.errors),\n        tariffError: req.body\n      });\n    }\n    req.user.update({ $addToSet: { plans: { _id: plan._id } } }, {}, function(err) {\n      if (err) {\n        Plan.findOneAndRemove({_id: plan._id}, function(err){\n          if (err) {\n            res.send(500);\n          }\n          return res.render('/plan/payment', {\n            action: \"/tariffs/\" + tariff.name + \"/create\",\n            title: \"Tariff details\",\n            countries: countries,\n            tariff: tariff,\n            errors: utils.errors(err.errors),\n            tariffError: req.body\n          });\n        });\n      }\n      return res.redirect('/users/' + req.user.id)\n    });\n  });\n\n  /*\n   var user = new User(req.body);\n\n   user.provider = 'local';\n   user.save(function(err) {\n   if (err) {\n   return res.render('users/signup', {\n   error: utils.errors(err.errors),\n   user: user,\n   title: 'Sign up'\n   });\n   }\n\n   // manually login the user once successfully signed up\n   req.logIn(user, function(err) {\n   if (err) req.flash('info', 'Sorry! We are not able to log you in!');\n   return res.redirect('/');\n   });\n   });\n   */\n};\n\n/**\n *  Show profile\n */\nexports.show = function(req, res) {\n  var user = req.profile;\n  res.render('users/show', {\n    title: user.name,\n    user: user\n  });\n};\n\n"]}